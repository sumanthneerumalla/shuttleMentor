# Production-specific overrides
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
name: shuttlementor-prod

# Production-specific networks
networks:
  frontend:
    name: shuttlementor-prod-frontend
  backend:
    name: shuttlementor-prod-backend
    internal: true

services:
  app:
    container_name: shuttlementor-app-prod
    build:
      target: runner
      args:
        - DATABASE_URL=${DATABASE_URL}
        - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
        - NODE_ENV=production
    environment:
      - NODE_ENV=production
      - PORT=3001  # Tell Next.js to use port 3001 internally
    restart: always
    # No source code volumes in production
    volumes: []
    command: ["sh", "-c", "PORT=3001 npm start"]
    # Override ALL ports to avoid inheriting port 3000 from base compose file
    ports:
      - "3001:3001"  # Map external 3001 to internal 3001
      - "5556:5556"  # Map external 5556 to internal 5556 for Prisma Studio
      # - "9229:9229"  # Debug port (commented out for production, but can enable for development)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
  db:
    container_name: shuttlementor-db-prod
    ports:
      - "5433:5432"  # PostgreSQL port (mapped to 5433 externally)
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data

volumes:
  postgres_data_prod:
    name: shuttlementor-prod-postgres-data
